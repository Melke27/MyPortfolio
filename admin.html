<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Melkamu Wako</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8BC34A;
            --secondary: #689F38;
            --dark: #212529;
        }

        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', sans-serif;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--dark) 0%, #343a40 100%);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: var(--primary);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .hidden {
            display: none !important;
        }

        .stat-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .stat-card.blogs {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card.contacts {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .stat-card.projects {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .stat-card.skills {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .stat-card.certs {
            background: linear-gradient(135deg, #fa709a, #fee140);
        }

        .stat-card.exp {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                z-index: 9999;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9998;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .mobile-header {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                padding: 15px;
                background: var(--dark);
                color: white;
                position: sticky;
                top: 0;
                z-index: 9997;
            }

            .hamburger-btn {
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 5px 10px;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 15px !important;
            }

            /* Stack stat cards on mobile */
            .stat-card {
                margin-bottom: 15px;
            }

            /* Adjust table for mobile */
            .table-responsive {
                font-size: 0.85rem;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 8px 4px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100px;
            }

            /* Adjust forms for mobile */
            .form-control,
            .form-select {
                font-size: 0.9rem;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            /* Adjust modals for mobile */
            .modal-dialog {
                margin: 10px !important;
            }

            h3 {
                font-size: 1.3rem !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login -->
    <div id="loginScreen" class="container login-container">
        <div class="card">
            <div class="card-header text-center py-4">
                <h4><i class="fas fa-user-shield me-2"></i>Admin Login</h4>
            </div>
            <div class="card-body p-4">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required
                            autocomplete="current-password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API URL</label>
                        <input type="text" class="form-control" id="apiUrl"
                            value="https://melkamuwako27-backend.onrender.com/api" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100"><i
                            class="fas fa-sign-in-alt me-2"></i>Login</button>
                </form>

            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="hamburger-btn" id="hamburgerBtn">
                <i class="fas fa-bars"></i>
            </button>
            <span><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</span>
            <span></span>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3 col-lg-2 sidebar p-0">
                    <div class="p-3 text-center border-bottom border-secondary">
                        <h5><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</h5>
                        <small class="text-muted">Melkamu Wako</small>
                    </div>
                    <nav class="nav flex-column p-2">
                        <a class="nav-link active" href="#" data-page="dashboard"><i
                                class="fas fa-home me-2"></i>Dashboard</a>
                        <a class="nav-link" href="#" data-page="blogs"><i class="fas fa-blog me-2"></i>Blog Posts</a>
                        <a class="nav-link" href="#" data-page="projects"><i class="fas fa-folder me-2"></i>Projects</a>
                        <a class="nav-link" href="#" data-page="skills"><i class="fas fa-code me-2"></i>Skills</a>
                        <a class="nav-link" href="#" data-page="certs"><i
                                class="fas fa-certificate me-2"></i>Certifications</a>
                        <a class="nav-link" href="#" data-page="exp"><i class="fas fa-briefcase me-2"></i>Experience</a>
                        <a class="nav-link" href="#" data-page="contacts"><i
                                class="fas fa-envelope me-2"></i>Messages</a>
                        <a class="nav-link" href="#" data-page="subs"><i class="fas fa-users me-2"></i>Subscribers</a>
                        <a class="nav-link" href="#" data-page="settings"><i class="fas fa-cog me-2"></i>Settings</a>
                        <a class="nav-link" href="#" data-page="testimonials"><i
                                class="fas fa-quote-left me-2"></i>Testimonials</a>
                        <a class="nav-link" href="/" target="_blank"><i class="fas fa-external-link-alt me-2"></i>View
                            Website</a>
                        <a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
                    </nav>
                </div>
                <div class="col-md-9 col-lg-10 main-content" style="padding:20px;">
                    <!-- Dashboard Page -->
                    <div id="dashboardPage">
                        <h3><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h3>
                        <div class="row mt-4">
                            <div class="col-6 col-md-2">
                                <div class="stat-card blogs">
                                    <h3 id="blogCount">0</h3>
                                    <p>Blogs</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="stat-card projects">
                                    <h3 id="projectCount">0</h3>
                                    <p>Projects</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="stat-card skills">
                                    <h3 id="skillCount">0</h3>
                                    <p>Skills</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="stat-card certs">
                                    <h3 id="certCount">0</h3>
                                    <p>Certs</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="stat-card exp">
                                    <h3 id="expCount">0</h3>
                                    <p>Experience</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="stat-card contacts">
                                    <h3 id="contactCount">0</h3>
                                    <p>Messages</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Blogs Page -->
                    <div id="blogsPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3><i class="fas fa-blog me-2"></i>Blog Posts</h3>
                            <button class="btn btn-primary" onclick="showForm('blog')"><i class="fas fa-plus"></i> New
                                Post</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Slug</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="blogsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Projects Page -->
                    <div id="projectsPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3><i class="fas fa-folder me-2"></i>Projects</h3>
                            <button class="btn btn-primary" onclick="showForm('project')"><i class="fas fa-plus"></i>
                                New Project</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="projectsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Page -->
                    <div id="skillsPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3><i class="fas fa-code me-2"></i>Skills</h3>
                            <button class="btn btn-primary" onclick="showForm('skill')"><i class="fas fa-plus"></i> New
                                Skill</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th>Level</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="skillsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certifications Page -->
                    <div id="certsPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3><i class="fas fa-certificate me-2"></i>Certifications</h3>
                            <button class="btn btn-primary" onclick="showForm('cert')"><i class="fas fa-plus"></i> New
                                Cert</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Issuer</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="certsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Experience Page -->
                    <div id="expPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3><i class="fas fa-briefcase me-2"></i>Experience</h3>
                            <button class="btn btn-primary" onclick="showForm('exp')"><i class="fas fa-plus"></i> New
                                Experience</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Company</th>
                                                <th>Period</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts Page -->
                    <div id="contactsPage" class="hidden">
                        <h3><i class="fas fa-envelope me-2"></i>Messages</h3>
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Subject</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="contactsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subscribers Page -->
                    <div id="subsPage" class="hidden">
                        <h3><i class="fas fa-users me-2"></i>Subscribers</h3>
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Email</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Testimonials Page -->
                    <div id="testimonialsPage" class="hidden">
                        <h3><i class="fas fa-quote-left me-2"></i>Testimonials</h3>
                        <div class="card mt-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i>All Testimonials</span>
                                <button class="btn btn-sm btn-primary" onclick="showForm('testimonial')"><i
                                        class="fas fa-plus me-1"></i>Add Testimonial</button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Company</th>
                                                <th>Rating</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="testimonialsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Page -->
                    <div id="settingsPage" class="hidden">
                        <h3><i class="fas fa-cog me-2"></i>Settings</h3>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header"><i class="fas fa-user-shield me-2"></i>Admin Profile</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-control" value="admin" disabled>
                                            <small class="text-muted">Contact developer to change username</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Change Password</label>
                                            <input type="password" class="form-control" id="adminNewPass"
                                                placeholder="New password">
                                        </div>
                                        <button class="btn btn-primary" onclick="updatePassword()"><i
                                                class="fas fa-save me-2"></i>Update Password</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header"><i class="fas fa-server me-2"></i>API Configuration</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">API Base URL</label>
                                            <input type="text" class="form-control" id="settingsApiUrl"
                                                placeholder="https://melkamuwako27-backend.onrender.com/api">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Database Status</label>
                                            <div><span class="badge bg-success"><i
                                                        class="fas fa-check-circle me-1"></i>Connected</span></div>
                                        </div>
                                        <button class="btn btn-primary" onclick="saveApiSettings()"><i
                                                class="fas fa-save me-2"></i>Save Settings</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header"><i class="fas fa-database me-2"></i>Database Statistics
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <h4 id="statBlogs">0</h4>
                                                <p class="text-muted">Blog Posts</p>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 id="statSkills">0</h4>
                                                <p class="text-muted">Skills</p>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 id="statCerts">0</h4>
                                                <p class="text-muted">Certifications</p>
                                            </div>
                                            <div class="col-md-3">
                                                <h4 id="statExp">0</h4>
                                                <p class="text-muted">Experience</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header"><i class="fas fa-shield-alt me-2"></i>Security</div>
                                    <div class="card-body">
                                        <button class="btn btn-warning" onclick="logoutAll()"><i
                                                class="fas fa-sign-out-alt me-2"></i>Logout All Sessions</button>
                                        <button class="btn btn-danger ms-2" onclick="clearAllData()"><i
                                                class="fas fa-trash me-2"></i>Clear All Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forms -->
                    <div id="formPage" class="hidden">
                        <div class="d-flex justify-content-between mb-4">
                            <h3 id="formTitle">Add New</h3>
                            <button class="btn btn-outline-secondary" onclick="showPage(lastPage)"><i
                                    class="fas fa-arrow-left"></i> Back</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <form id="dataForm"></form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Clear old cached localhost URL if exists
        const oldUrl = localStorage.getItem('blogAdminApiUrl');
        if (oldUrl && oldUrl.includes('localhost')) {
            localStorage.removeItem('blogAdminApiUrl');
        }
        let apiUrl = 'https://melkamuwako27-backend.onrender.com/api', authToken = null, lastPage = 'dashboard', editingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('blogAdminApiUrl');
            if (saved) apiUrl = saved;
            const token = localStorage.getItem('blogAdminToken');
            if (token) { authToken = token; showDashboard(); loadData(); }

            // Mobile sidebar toggle
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (hamburgerBtn && sidebar) {
                hamburgerBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    if (sidebarOverlay) sidebarOverlay.classList.toggle('active');
                });

                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                    });
                }
            }

            // Close sidebar when clicking nav link on mobile
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                    }
                });
            });
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            apiUrl = document.getElementById('apiUrl').value;
            if (u === 'admin' && p === 'melkamu2025') {
                authToken = btoa(u + ':' + p);
                localStorage.setItem('blogAdminToken', authToken);
                localStorage.setItem('blogAdminApiUrl', apiUrl);
                showDashboard(); loadData(); showToast('Login successful!', 'success');
            } else showToast('Invalid credentials', 'danger');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('blogAdminToken');
            authToken = null;
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (dashboard) dashboard.classList.add('hidden');
        });

        document.querySelectorAll('.nav-link[data-page]').forEach(l => l.addEventListener('click', e => {
            e.preventDefault();
            showPage(e.target.closest('.nav-link').dataset.page);
        }));

        function showPage(page) {
            lastPage = page;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link[data-page="' + page + '"]')?.classList.add('active');
            ['dashboardPage', 'blogsPage', 'projectsPage', 'skillsPage', 'certsPage', 'expPage', 'contactsPage', 'subsPage', 'settingsPage', 'testimonialsPage', 'formPage'].forEach(p => document.getElementById(p)?.classList.add('hidden'));
            document.getElementById(page + 'Page')?.classList.remove('hidden');
            loadData();
            if (page === 'settings') { loadSettings(); loadStats(); }
        }

        function showDashboard() {
            const loginScreenEl = document.getElementById('loginScreen');
            const dashboardEl = document.getElementById('dashboard');
            if (loginScreenEl) loginScreenEl.classList.add('hidden');
            if (dashboardEl) dashboardEl.classList.remove('hidden');
            showPage('dashboard');
        }

        async function loadData() {
            try {
                const [blogs, projects, skills, certs, exp, contacts, subs, testimonials] = await Promise.all([
                    fetch(apiUrl + '/blogposts').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/projects').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/skills').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/certifications').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/experiences').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/contacts').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/subscribers').then(r => r.ok ? r.json() : []),
                    fetch(apiUrl + '/testimonials').then(r => r.ok ? r.json() : [])
                ]);
                const countElements = {
                    blogCount: blogs.length,
                    projectCount: projects.length,
                    skillCount: skills.length,
                    certCount: certs.length,
                    expCount: exp.length,
                    contactCount: contacts.length
                };
                Object.entries(countElements).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                });

                renderTable('blogsTable', blogs, ['title', 'slug', 'date'], 'blog');
                renderTable('projectsTable', projects, ['name', 'category'], 'project');
                renderTable('skillsTable', skills, ['name', 'category', 'level'], 'skill');
                renderTable('certsTable', certs, ['name', 'issuer', 'date'], 'cert');
                renderTable('expTable', exp, ['title', 'company', 'startDate'], 'exp');
                renderTable('contactsTable', contacts, ['name', 'email', 'subject', 'createdAt'], 'contact');
                renderTable('subsTable', subs, ['email', 'subscribedAt'], 'sub');
                renderTable('testimonialsTable', testimonials, ['name', 'company', 'role', 'rating'], 'testimonial');
            } catch (e) { console.error(e); }
        }

        function renderTable(id, data, fields, type) {
            const tbody = document.getElementById(id);
            if (!tbody) return;
            if (!data.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No data</td></tr>'; return; }
            tbody.innerHTML = data.map(d => '<tr>' + fields.map(f => '<td>' + (f === 'date' || f === 'createdAt' || f === 'startDate' ? new Date(d[f]).toLocaleDateString() : escapeHtml(d[f] || '-')) + '</td>').join('') +
                '<td><button class="btn btn-sm btn-primary me-1" onclick="edit(\'' + type + '\',\'' + d._id + '\')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="del(\'' + type + '\',\'' + d._id + '\')"><i class="fas fa-trash"></i></button></td></tr>').join('');
        }

        function showForm(type) {
            editingId = null;
            const lastPageEl = document.getElementById(lastPage + 'Page');
            const formPageEl = document.getElementById('formPage');
            if (lastPageEl) lastPageEl.classList.add('hidden');
            if (formPageEl) formPageEl.classList.remove('hidden');
            const titles = { blog: 'Blog Post', project: 'Project', skill: 'Skill', cert: 'Certification', exp: 'Experience', testimonial: 'Testimonial' };
            const formTitleEl = document.getElementById('formTitle');
            if (formTitleEl) formTitleEl.textContent = 'New ' + titles[type];
            const forms = {
                blog: '<input type="hidden" id="editId"><div class="mb-3"><label>Title</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Slug</label><input type="text" class="form-control" id="f2" required></div><div class="mb-3"><label>Description</label><textarea class="form-control" id="f3" required></textarea></div><div class="mb-3"><label>Content</label><textarea class="form-control" id="f4" rows="5"></textarea></div><div class="mb-3"><label>Image URL</label><input type="text" class="form-control" id="f5"></div><div class="mb-3"><label>Tags</label><input type="text" class="form-control" id="f6" placeholder="tag1, tag2"></div><button type="submit" class="btn btn-primary">Save</button>',
                project: '<input type="hidden" id="editId"><div class="mb-3"><label>Name</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Slug</label><input type="text" class="form-control" id="f2" required></div><div class="mb-3"><label>Description</label><textarea class="form-control" id="f3"></textarea></div><div class="mb-3"><label>Image URL</label><input type="text" class="form-control" id="f4"></div><div class="mb-3"><label>Category</label><input type="text" class="form-control" id="f5"></div><div class="mb-3"><label>Live URL</label><input type="text" class="form-control" id="f6"></div><div class="mb-3"><label>GitHub URL</label><input type="text" class="form-control" id="f7"></div><button type="submit" class="btn btn-primary">Save</button>',
                skill: '<input type="hidden" id="editId"><div class="mb-3"><label>Name</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Category</label><input type="text" class="form-control" id="f2" placeholder="Frontend, Backend, etc."></div><div class="mb-3"><label>Level (0-100)</label><input type="number" class="form-control" id="f3" min="0" max="100"></div><button type="submit" class="btn btn-primary">Save</button>',
                cert: '<input type="hidden" id="editId"><div class="mb-3"><label>Name</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Issuer</label><input type="text" class="form-control" id="f2" required></div><div class="mb-3"><label>Description</label><textarea class="form-control" id="f3"></textarea></div><div class="mb-3"><label>Image URL</label><input type="text" class="form-control" id="f4"></div><div class="mb-3"><label>Date</label><input type="date" class="form-control" id="f5"></div><div class="mb-3"><label>URL</label><input type="text" class="form-control" id="f6"></div><button type="submit" class="btn btn-primary">Save</button>',
                exp: '<input type="hidden" id="editId"><div class="mb-3"><label>Title</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Company</label><input type="text" class="form-control" id="f2" required></div><div class="mb-3"><label>Location</label><input type="text" class="form-control" id="f3"></div><div class="mb-3"><label>Description</label><textarea class="form-control" id="f4"></textarea></div><div class="mb-3"><label>Start Date</label><input type="date" class="form-control" id="f5"></div><div class="mb-3"><label>End Date</label><input type="date" class="form-control" id="f6"></div><div class="mb-3"><label><input type="checkbox" id="f7"> Current Position</label></div><button type="submit" class="btn btn-primary">Save</button>',
                testimonial: '<input type="hidden" id="editId"><div class="mb-3"><label>Name</label><input type="text" class="form-control" id="f1" required></div><div class="mb-3"><label>Company</label><input type="text" class="form-control" id="f2"></div><div class="mb-3"><label>Role/Position</label><input type="text" class="form-control" id="f3"></div><div class="mb-3"><label>Rating (1-5)</label><input type="number" class="form-control" id="f4" min="1" max="5"></div><div class="mb-3"><label>Message</label><textarea class="form-control" id="f5" rows="4"></textarea></div><div class="mb-3"><label>Image URL</label><input type="text" class="form-control" id="f6" onchange="previewTestimonialImage(this.value)"><div id="testimonialImagePreview" class="mt-2"></div></div><div class="mb-3"><label><input type="checkbox" id="f7"> Featured</label></div><button type="submit" class="btn btn-primary">Save</button>'
            };
            document.getElementById('dataForm').innerHTML = forms[type];
            document.getElementById('dataForm')?.addEventListener('submit', (e) => { e.preventDefault(); save(type); });

            // Auto slug for blog/project
            if (type === 'blog' || type === 'project') {
                document.getElementById('f1').oninput = () => {
                    if (!editingId) document.getElementById('f2').value = document.getElementById('f1').value.toLowerCase().replace(/[^a-z0-9]/g, '-');
                };
            }

            // Image preview for testimonial
            if (type === 'testimonial') {
                const f6 = document.getElementById('f6');
                if (f6) {
                    f6.addEventListener('input', function () {
                        previewTestimonialImage(this.value);
                    });
                }
            }
        }

        function previewTestimonialImage(url) {
            const preview = document.getElementById('testimonialImagePreview');
            if (!preview) return;
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" class="rounded" style="width:100px;height:100px;object-fit:cover;">`;
            } else {
                preview.innerHTML = '';
            }
        }

        const endpoints = { blog: 'blogposts', project: 'projects', skill: 'skills', cert: 'certifications', exp: 'experiences', contact: 'contacts', sub: 'subscribers', testimonial: 'testimonials' };
        async function edit(type, id) {
            console.log('Edit called with type:', type, 'id:', id);
            const url = apiUrl + '/' + endpoints[type];
            console.log('Fetching URL:', url);
            const res = await fetch(url);
            const data = await res.json();
            const item = data.find(d => d._id === id);
            if (!item) return;

            editingId = id;
            const editLastPageEl = document.getElementById(lastPage + 'Page');
            const editFormPageEl = document.getElementById('formPage');
            if (editLastPageEl) editLastPageEl.classList.add('hidden');
            if (editFormPageEl) editFormPageEl.classList.remove('hidden');
            const titles = { blog: 'Edit Blog Post', project: 'Edit Project', skill: 'Edit Skill', cert: 'Edit Certification', exp: 'Edit Experience', testimonial: 'Edit Testimonial' };
            const formTitleEl = document.getElementById('formTitle');
            if (formTitleEl) formTitleEl.textContent = titles[type];

            // Reuse form but set values
            showForm(type);
            document.getElementById('editId').value = id;
            const maps = {
                blog: ['f1', 'f2', 'f3', 'f4', 'f5', 'f6'],
                project: ['f1', 'f2', 'f3', 'f4', 'f5', 'f6', 'f7'],
                skill: ['f1', 'f2', 'f3'],
                cert: ['f1', 'f2', 'f3', 'f4', 'f5', 'f6'],
                exp: ['f1', 'f2', 'f3', 'f4', 'f5', 'f6', 'f7'],
                testimonial: ['f1', 'f2', 'f3', 'f4', 'f5', 'f6', 'f7']
            };
            const fields = { blog: ['title', 'slug', 'description', 'content', 'imageUrl', 'tags'], project: ['name', 'slug', 'description', 'imageUrl', 'category', 'liveUrl', 'githubUrl'], skill: ['name', 'category', 'level'], cert: ['name', 'issuer', 'description', 'imageUrl', 'date', 'url'], exp: ['title', 'company', 'location', 'description', 'startDate', 'endDate', 'current'], testimonial: ['name', 'company', 'role', 'rating', 'message', 'imageUrl', 'featured'] };
            maps[type].forEach((f, i) => {
                const val = item[fields[type][i]];
                if (fields[type][i] === 'current' || fields[type][i] === 'featured') document.getElementById(f).checked = val;
                else document.getElementById(f).value = val || '';
            });

            // Show image preview for testimonial when editing
            if (type === 'testimonial' && item.imageUrl) {
                previewTestimonialImage(item.imageUrl);
            }
        }

        async function save(type) {
            const id = document.getElementById('editId')?.value;
            let data = {};

            if (type === 'blog') {
                data = { title: f('f1'), slug: f('f2'), description: f('f3'), content: f('f4'), imageUrl: f('f5'), tags: f('f6').split(',').map(t => t.trim()).filter(t => t) };
            } else if (type === 'project') {
                data = { name: f('f1'), slug: f('f2'), description: f('f3'), imageUrl: f('f4'), category: f('f5'), liveUrl: f('f6'), githubUrl: f('f7') };
            } else if (type === 'skill') {
                data = { name: f('f1'), category: f('f2'), level: parseInt(f('f3')) || 0 };
            } else if (type === 'cert') {
                data = { name: f('f1'), issuer: f('f2'), description: f('f3'), imageUrl: f('f4'), date: f('f5'), url: f('f6') };
            } else if (type === 'exp') {
                data = { title: f('f1'), company: f('f2'), location: f('f3'), description: f('f4'), startDate: f('f5'), endDate: f('f6'), current: document.getElementById('f7')?.checked || false };
            } else if (type === 'testimonial') {
                data = { name: f('f1'), company: f('f2'), role: f('f3'), rating: parseInt(f('f4')) || 5, message: f('f5'), imageUrl: f('f6'), featured: document.getElementById('f7')?.checked || false };
            }

            const url = id ? apiUrl + '/' + endpoints[type] + '/' + id : apiUrl + '/' + endpoints[type];
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (res.ok) { showToast(id ? 'Updated!' : 'Created!', 'success'); showPage(lastPage); }
            else showToast('Error', 'danger');
        }

        function f(id) { const el = document.getElementById(id); return el ? el.value : ''; }

        async function del(type, id) {
            if (!confirm('Delete?')) return;
            await fetch(apiUrl + '/' + endpoints[type] + '/' + id, { method: 'DELETE' });
            showToast('Deleted', 'success');
            loadData();
        }

        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // Settings functions
        function updatePassword() {
            const newPass = document.getElementById('adminNewPass').value;
            if (newPass && newPass.length >= 6) {
                localStorage.setItem('adminPassword', btoa(newPass));
                showToast('Password updated successfully!', 'success');
            } else {
                showToast('Password must be at least 6 characters', 'danger');
            }
        }

        function saveApiSettings() {
            const apiUrl = document.getElementById('settingsApiUrl').value;
            if (apiUrl) {
                localStorage.setItem('blogAdminApiUrl', apiUrl);
                showToast('API settings saved!', 'success');
            }
        }

        function logoutAll() {
            if (confirm('Logout from all devices?')) {
                localStorage.removeItem('blogAdminToken');
                window.location.href = 'login.html';
            }
        }

        function clearAllData() {
            if (confirm('WARNING: This will delete ALL data! Are you sure?')) {
                if (confirm('This cannot be undone! Confirm?')) {
                    showToast('Data cleared - contact developer to restore', 'warning');
                }
            }
        }

        function loadSettings() {
            const settingsApiUrlEl = document.getElementById('settingsApiUrl');
            if (settingsApiUrlEl) settingsApiUrlEl.value = localStorage.getItem('blogAdminApiUrl') || 'https://melkamuwako27-backend.onrender.com/api';
        }

        function loadStats() {
            // Update settings page stats
            const statMappings = [
                ['statBlogs', 'blogCount'],
                ['statSkills', 'skillCount'],
                ['statCerts', 'certCount'],
                ['statExp', 'expCount']
            ];
            statMappings.forEach(([statId, countId]) => {
                const statEl = document.getElementById(statId);
                const countEl = document.getElementById(countId);
                if (statEl && countEl) statEl.textContent = countEl.textContent;
            });
        }
        function showToast(m, t) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-' + (t || 'info') + ' border-0';
            toast.innerHTML = '<div class="d-flex"><div class="toast-body">' + m + '</div><button class="btn-close btn-close-white me-2" data-bs-dismiss="toast"></button></div>';
            document.getElementById('toastContainer').appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>